<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOC Seguro - Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/error-handler.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="js/demo-mode.js"></script>
    <script src="js/api.js"></script>
    <script src="js/router.js"></script>
    <script src="js/error-handler.js"></script>
</head>
<body>
    <header>
        <div class="container header-container">
            <a href="index.html" class="logo">LOC<span>Seguro</span></a>
            <nav>
                <ul>
                    <li><a href="index.html">Início</a></li>
                    <li><a href="dashboard.html" class="active">Dashboard</a></li>
                    <li><a href="perfil.html">Meu Perfil</a></li>
                    <li><a href="javascript:void(0);" onclick="logout()">Sair</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="page-header">
                <h1>Dashboard</h1>
                <p id="welcome-message">Bem-vindo ao seu painel de controle</p>
            </div>
            
            <div id="error-container" class="notification offline-notification" style="display: none;">
                <div class="notification-icon"><i class="fas fa-wifi-slash"></i></div>
                <div class="notification-content">
                    <h3>Modo Demonstração Ativo</h3>
                    <p>O servidor está temporariamente indisponível. Você está usando o sistema em modo de demonstração.</p>
                </div>
                <button class="notification-close" onclick="this.parentElement.style.display='none'">×</button>
            </div>
            
            <!-- Conteúdo específico para Locadoras -->
            <div id="locadora-dashboard" style="display: none;">
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2>Meus Carros</h2>
                        <a href="cadastro-carro.html" class="btn btn-primary btn-sm">Cadastrar Novo Carro</a>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table" id="carros-table">
                            <thead>
                                <tr>
                                    <th>Marca/Modelo</th>
                                    <th>Ano</th>
                                    <th>Placa</th>
                                    <th>Cor</th>
                                    <th>Quilometragem</th>
                                    <th>Valor Diária</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão carregados dinamicamente -->
                                <tr>
                                    <td colspan="8" class="text-center">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2>Clientes que Alugaram</h2>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table" id="clientes-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>CPF</th>
                                    <th>Telefone</th>
                                    <th>Avaliação Média</th>
                                    <th>Total de Locações</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão carregados dinamicamente -->
                                <tr>
                                    <td colspan="6" class="text-center">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2>Minhas Locações</h2>
                        <a href="cadastro-locacao.html" class="btn btn-primary btn-sm">Cadastrar Nova Locação</a>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table" id="locacoes-table">
                            <thead>
                                <tr>
                                    <th>Carro</th>
                                    <th>Locatário</th>
                                    <th>Período</th>
                                    <th>Valor Total</th>
                                    <th>Status</th>
                                    <th>Avaliação</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão carregados dinamicamente -->
                                <tr>
                                    <td colspan="7" class="text-center">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo específico para Locatários -->
            <div id="locatario-dashboard" style="display: none;">
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2>Carros Disponíveis</h2>
                        <div class="search-container">
                            <input type="text" id="search-carros" placeholder="Buscar carros...">
                            <button class="btn btn-primary btn-sm" onclick="buscarCarros()">Buscar</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table" id="carros-disponiveis-table">
                            <thead>
                                <tr>
                                    <th>Marca/Modelo</th>
                                    <th>Ano</th>
                                    <th>Cor</th>
                                    <th>Quilometragem</th>
                                    <th>Valor Diária</th>
                                    <th>Locadora</th>
                                    <th>Avaliação</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão carregados dinamicamente -->
                                <tr>
                                    <td colspan="8" class="text-center">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2>Minhas Locações</h2>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table" id="minhas-locacoes-table">
                            <thead>
                                <tr>
                                    <th>Carro</th>
                                    <th>Locadora</th>
                                    <th>Período</th>
                                    <th>Valor Total</th>
                                    <th>Status</th>
                                    <th>Avaliação</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão carregados dinamicamente -->
                                <tr>
                                    <td colspan="7" class="text-center">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2>Locadoras Avaliadas</h2>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table" id="locadoras-avaliadas-table">
                            <thead>
                                <tr>
                                    <th>Locadora</th>
                                    <th>CNPJ</th>
                                    <th>Telefone</th>
                                    <th>Cidade/UF</th>
                                    <th>Avaliação Média</th>
                                    <th>Minha Avaliação</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão carregados dinamicamente -->
                                <tr>
                                    <td colspan="7" class="text-center">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 LOC Seguro - Sistema de Locação de Carros com Avaliação e Multa</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se o usuário está logado
            const usuarioStr = localStorage.getItem('usuario');
            if (!usuarioStr) {
                window.location.href = 'login.html?redirect=dashboard.html';
                return;
            }
            
            // Obter dados do usuário
            const usuario = JSON.parse(usuarioStr);
            
            // Atualizar mensagem de boas-vindas
            const welcomeMessage = document.getElementById('welcome-message');
            if (usuario.tipo === 'locadora') {
                welcomeMessage.textContent = `Bem-vindo, ${usuario.razaoSocial || 'Locadora'}!`;
                document.getElementById('locadora-dashboard').style.display = 'block';
            } else if (usuario.tipo === 'locatario') {
                welcomeMessage.textContent = `Bem-vindo, ${usuario.nome || 'Locatário'}!`;
                document.getElementById('locatario-dashboard').style.display = 'block';
            }
            
            // Verificar conexão com o backend
            checkBackendConnection().then(isConnected => {
                if (!isConnected) {
                    document.getElementById('error-container').style.display = 'flex';
                    
                    // Carregar dados de demonstração
                    loadDemoData();
                    
                    // Carregar dados offline
                    if (usuario.tipo === 'locadora') {
                        carregarCarrosOffline(usuario.id);
                        carregarClientesOffline(usuario.id);
                        carregarLocacoesOffline(usuario.id);
                    } else if (usuario.tipo === 'locatario') {
                        carregarCarrosDisponiveisOffline();
                        carregarMinhasLocacoesOffline(usuario.id);
                        carregarLocadorasAvaliadasOffline(usuario.id);
                    }
                } else {
                    // Carregar dados do backend
                    if (usuario.tipo === 'locadora') {
                        carregarCarros(usuario.id);
                        carregarClientes(usuario.id);
                        carregarLocacoes(usuario.id);
                    } else if (usuario.tipo === 'locatario') {
                        carregarCarrosDisponiveis();
                        carregarMinhasLocacoes(usuario.id);
                        carregarLocadorasAvaliadas(usuario.id);
                    }
                }
            });
        });
        
        // Função para carregar carros da locadora (online)
        async function carregarCarros(locadoraId) {
            try {
                const response = await fetch(`http://3000-ijxwfwvnyu523t66vmw52-13f789e2.manus.computer/api/carro/locadora/${locadoraId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const carros = await response.json();
                    renderizarCarros(carros);
                } else {
                    throw new Error('Erro ao carregar carros');
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                carregarCarrosOffline(locadoraId);
            }
        }
        
        // Função para carregar carros da locadora (offline)
        function carregarCarrosOffline(locadoraId) {
            const carros = JSON.parse(localStorage.getItem('demoCarros') || '[]');
            const carrosDaLocadora = carros.filter(carro => carro.locadoraId == locadoraId);
            renderizarCarros(carrosDaLocadora);
        }
        
        // Função para renderizar carros na tabela
        function renderizarCarros(carros) {
            const tbody = document.querySelector('#carros-table tbody');
            
            if (carros.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum carro cadastrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            carros.forEach(carro => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${carro.marca} ${carro.modelo}</td>
                    <td>${carro.ano}</td>
                    <td>${carro.placa}</td>
                    <td>${carro.cor}</td>
                    <td>${carro.quilometragem} km</td>
                    <td>R$ ${parseFloat(carro.valorDiaria).toFixed(2)}</td>
                    <td>${carro.disponivel ? '<span class="badge badge-success">Disponível</span>' : '<span class="badge badge-danger">Indisponível</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="visualizarCarro(${carro.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-primary" onclick="editarCarro(${carro.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="excluirCarro(${carro.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Função para carregar clientes que alugaram com a locadora (online)
        async function carregarClientes(locadoraId) {
            try {
                const response = await fetch(`http://3000-ijxwfwvnyu523t66vmw52-13f789e2.manus.computer/api/locadora/${locadoraId}/clientes`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const clientes = await response.json();
                    renderizarClientes(clientes);
                } else {
                    throw new Error('Erro ao carregar clientes');
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                carregarClientesOffline(locadoraId);
            }
        }
        
        // Função para carregar clientes que alugaram com a locadora (offline)
        function carregarClientesOffline(locadoraId) {
            const locacoes = JSON.parse(localStorage.getItem('demoLocacoes') || '[]');
            const locatarios = JSON.parse(localStorage.getItem('demoUsuarios') || '[]').filter(u => u.tipo === 'locatario');
            
            // Filtrar locações da locadora
            const locacoesDaLocadora = locacoes.filter(locacao => locacao.locadoraId == locadoraId);
            
            // Obter IDs únicos de locatários
            const locatarioIds = [...new Set(locacoesDaLocadora.map(locacao => locacao.locatarioId))];
            
            // Obter dados completos dos locatários
            const clientes = locatarioIds.map(id => {
                const locatario = locatarios.find(l => l.id == id);
                const locacoesDoLocatario = locacoesDaLocadora.filter(l => l.locatarioId == id);
                
                // Calcular avaliação média
                const avaliacoes = locacoesDoLocatario.filter(l => l.avaliacaoLocatario !== null).map(l => l.avaliacaoLocatario);
                const avaliacaoMedia = avaliacoes.length > 0 ? avaliacoes.reduce((a, b) => a + b, 0) / avaliacoes.length : 0;
                
                return {
                    id: locatario.id,
                    nome: locatario.nome,
                    cpf: locatario.cpf,
                    telefone: locatario.telefone,
                    avaliacaoMedia: avaliacaoMedia,
                    totalLocacoes: locacoesDoLocatario.length
                };
            });
            
            renderizarClientes(clientes);
        }
        
        // Função para renderizar clientes na tabela
        function renderizarClientes(clientes) {
            const tbody = document.querySelector('#clientes-table tbody');
            
            if (clientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum cliente encontrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            clientes.forEach(cliente => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cliente.nome}</td>
                    <td>${cliente.cpf}</td>
                    <td>${cliente.telefone}</td>
                    <td>${renderizarEstrelas(cliente.avaliacaoMedia)}</td>
                    <td>${cliente.totalLocacoes}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="visualizarCliente(${cliente.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-primary" onclick="verLocacoesCliente(${cliente.id})"><i class="fas fa-list"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Função para carregar locações da locadora (online)
        async function carregarLocacoes(locadoraId) {
            try {
                const response = await fetch(`http://3000-ijxwfwvnyu523t66vmw52-13f789e2.manus.computer/api/locacao/locadora/${locadoraId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const locacoes = await response.json();
                    renderizarLocacoes(locacoes);
                } else {
                    throw new Error('Erro ao carregar locações');
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                carregarLocacoesOffline(locadoraId);
            }
        }
        
        // Função para carregar locações da locadora (offline)
        function carregarLocacoesOffline(locadoraId) {
            const locacoes = JSON.parse(localStorage.getItem('demoLocacoes') || '[]');
            const carros = JSON.parse(localStorage.getItem('demoCarros') || '[]');
            const locatarios = JSON.parse(localStorage.getItem('demoUsuarios') || '[]').filter(u => u.tipo === 'locatario');
            
            // Filtrar locações da locadora
            const locacoesDaLocadora = locacoes.filter(locacao => locacao.locadoraId == locadoraId);
            
            // Adicionar informações de carro e locatário
            const locacoesCompletas = locacoesDaLocadora.map(locacao => {
                const carro = carros.find(c => c.id == locacao.carroId);
                const locatario = locatarios.find(l => l.id == locacao.locatarioId);
                
                return {
                    ...locacao,
                    carro: carro ? `${carro.marca} ${carro.modelo}` : 'Desconhecido',
                    locatario: locatario ? locatario.nome : 'Desconhecido'
                };
            });
            
            renderizarLocacoes(locacoesCompletas);
        }
        
        // Função para renderizar locações na tabela
        function renderizarLocacoes(locacoes) {
            const tbody = document.querySelector('#locacoes-table tbody');
            
            if (locacoes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma locação encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            locacoes.forEach(locacao => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${locacao.carro}</td>
                    <td>${locacao.locatario}</td>
                    <td>${formatarData(locacao.dataInicio)} a ${formatarData(locacao.dataFim)}</td>
                    <td>R$ ${parseFloat(locacao.valorTotal).toFixed(2)}</td>
                    <td>${renderizarStatusLocacao(locacao.status)}</td>
                    <td>${locacao.avaliacaoLocatario !== null ? renderizarEstrelas(locacao.avaliacaoLocatario) : '<span class="badge badge-warning">Pendente</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="visualizarLocacao(${locacao.id})"><i class="fas fa-eye"></i></button>
                        ${locacao.status === 'Concluída' && locacao.avaliacaoLocadora === null ? 
                            `<button class="btn btn-sm btn-primary" onclick="avaliarLocatario(${locacao.id})"><i class="fas fa-star"></i></button>` : ''}
                        ${locacao.status === 'Em andamento' ? 
                            `<button class="btn btn-sm btn-success" onclick="concluirLocacao(${locacao.id})"><i class="fas fa-check"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Função para carregar carros disponíveis (online)
        async function carregarCarrosDisponiveis() {
            try {
                const response = await fetch(`http://3000-ijxwfwvnyu523t66vmw52-13f789e2.manus.computer/api/carro/disponiveis`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const carros = await response.json();
                    renderizarCarrosDisponiveis(carros);
                } else {
                    throw new Error('Erro ao carregar carros disponíveis');
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                carregarCarrosDisponiveisOffline();
            }
        }
        
        // Função para carregar carros disponíveis (offline)
        function carregarCarrosDisponiveisOffline() {
            const carros = JSON.parse(localStorage.getItem('demoCarros') || '[]');
            const locadoras = JSON.parse(localStorage.getItem('demoUsuarios') || '[]').filter(u => u.tipo === 'locadora');
            
            // Filtrar carros disponíveis
            const carrosDisponiveis = carros.filter(carro => carro.disponivel);
            
            // Adicionar informações da locadora
            const carrosCompletos = carrosDisponiveis.map(carro => {
                const locadora = locadoras.find(l => l.id == carro.locadoraId);
                
                return {
                    ...carro,
                    locadora: locadora ? locadora.razaoSocial : 'Desconhecida',
                    locadoraAvaliacao: locadora ? locadora.avaliacao : 0
                };
            });
            
            renderizarCarrosDisponiveis(carrosCompletos);
        }
        
        // Função para renderizar carros disponíveis na tabela
        function renderizarCarrosDisponiveis(carros) {
            const tbody = document.querySelector('#carros-disponiveis-table tbody');
            
            if (carros.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum carro disponível</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            carros.forEach(carro => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${carro.marca} ${carro.modelo}</td>
                    <td>${carro.ano}</td>
                    <td>${carro.cor}</td>
                    <td>${carro.quilometragem} km</td>
                    <td>R$ ${parseFloat(carro.valorDiaria).toFixed(2)}</td>
                    <td>${carro.locadora}</td>
                    <td>${renderizarEstrelas(carro.locadoraAvaliacao)}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="visualizarCarroDisponivel(${carro.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-success" onclick="solicitarLocacao(${carro.id})"><i class="fas fa-car"></i> Alugar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Função para carregar minhas locações (online)
        async function carregarMinhasLocacoes(locatarioId) {
            try {
                const response = await fetch(`http://3000-ijxwfwvnyu523t66vmw52-13f789e2.manus.computer/api/locacao/locatario/${locatarioId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const locacoes = await response.json();
                    renderizarMinhasLocacoes(locacoes);
                } else {
                    throw new Error('Erro ao carregar locações');
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                carregarMinhasLocacoesOffline(locatarioId);
            }
        }
        
        // Função para carregar minhas locações (offline)
        function carregarMinhasLocacoesOffline(locatarioId) {
            const locacoes = JSON.parse(localStorage.getItem('demoLocacoes') || '[]');
            const carros = JSON.parse(localStorage.getItem('demoCarros') || '[]');
            const locadoras = JSON.parse(localStorage.getItem('demoUsuarios') || '[]').filter(u => u.tipo === 'locadora');
            
            // Filtrar locações do locatário
            const locacoesDoLocatario = locacoes.filter(locacao => locacao.locatarioId == locatarioId);
            
            // Adicionar informações de carro e locadora
            const locacoesCompletas = locacoesDoLocatario.map(locacao => {
                const carro = carros.find(c => c.id == locacao.carroId);
                const locadora = locadoras.find(l => l.id == locacao.locadoraId);
                
                return {
                    ...locacao,
                    carro: carro ? `${carro.marca} ${carro.modelo}` : 'Desconhecido',
                    locadora: locadora ? locadora.razaoSocial : 'Desconhecida'
                };
            });
            
            renderizarMinhasLocacoes(locacoesCompletas);
        }
        
        // Função para renderizar minhas locações na tabela
        function renderizarMinhasLocacoes(locacoes) {
            const tbody = document.querySelector('#minhas-locacoes-table tbody');
            
            if (locacoes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma locação encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            locacoes.forEach(locacao => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${locacao.carro}</td>
                    <td>${locacao.locadora}</td>
                    <td>${formatarData(locacao.dataInicio)} a ${formatarData(locacao.dataFim)}</td>
                    <td>R$ ${parseFloat(locacao.valorTotal).toFixed(2)}</td>
                    <td>${renderizarStatusLocacao(locacao.status)}</td>
                    <td>${locacao.avaliacaoLocadora !== null ? renderizarEstrelas(locacao.avaliacaoLocadora) : '<span class="badge badge-warning">Pendente</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="visualizarMinhaLocacao(${locacao.id})"><i class="fas fa-eye"></i></button>
                        ${locacao.status === 'Concluída' && locacao.avaliacaoLocadora === null ? 
                            `<button class="btn btn-sm btn-primary" onclick="avaliarLocadora(${locacao.id})"><i class="fas fa-star"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Função para carregar locadoras avaliadas (online)
        async function carregarLocadorasAvaliadas(locatarioId) {
            try {
                const response = await fetch(`http://3000-ijxwfwvnyu523t66vmw52-13f789e2.manus.computer/api/locatario/${locatarioId}/locadoras-avaliadas`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const locadoras = await response.json();
                    renderizarLocadorasAvaliadas(locadoras);
                } else {
                    throw new Error('Erro ao carregar locadoras avaliadas');
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                carregarLocadorasAvaliadasOffline(locatarioId);
            }
        }
        
        // Função para carregar locadoras avaliadas (offline)
        function carregarLocadorasAvaliadasOffline(locatarioId) {
            const locacoes = JSON.parse(localStorage.getItem('demoLocacoes') || '[]');
            const locadoras = JSON.parse(localStorage.getItem('demoUsuarios') || '[]').filter(u => u.tipo === 'locadora');
            
            // Filtrar locações concluídas do locatário
            const locacoesConcluidas = locacoes.filter(locacao => 
                locacao.locatarioId == locatarioId && 
                locacao.status === 'Concluída'
            );
            
            // Obter IDs únicos de locadoras
            const locadoraIds = [...new Set(locacoesConcluidas.map(locacao => locacao.locadoraId))];
            
            // Obter dados completos das locadoras
            const locadorasAvaliadas = locadoraIds.map(id => {
                const locadora = locadoras.find(l => l.id == id);
                const locacoesComLocadora = locacoesConcluidas.filter(l => l.locadoraId == id);
                
                // Obter última avaliação
                const ultimaLocacao = locacoesComLocadora.sort((a, b) => 
                    new Date(b.dataFim) - new Date(a.dataFim)
                )[0];
                
                return {
                    id: locadora.id,
                    razaoSocial: locadora.razaoSocial,
                    cnpj: locadora.cnpj,
                    telefone: locadora.telefone,
                    cidade: locadora.cidade,
                    estado: locadora.estado,
                    avaliacaoMedia: locadora.avaliacao,
                    minhaAvaliacao: ultimaLocacao.avaliacaoLocadora
                };
            });
            
            renderizarLocadorasAvaliadas(locadorasAvaliadas);
        }
        
        // Função para renderizar locadoras avaliadas na tabela
        function renderizarLocadorasAvaliadas(locadoras) {
            const tbody = document.querySelector('#locadoras-avaliadas-table tbody');
            
            if (locadoras.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma locadora avaliada</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            locadoras.forEach(locadora => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${locadora.razaoSocial}</td>
                    <td>${locadora.cnpj}</td>
                    <td>${locadora.telefone}</td>
                    <td>${locadora.cidade}/${locadora.estado}</td>
                    <td>${renderizarEstrelas(locadora.avaliacaoMedia)}</td>
                    <td>${renderizarEstrelas(locadora.minhaAvaliacao)}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="visualizarLocadora(${locadora.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-primary" onclick="verCarrosLocadora(${locadora.id})"><i class="fas fa-car"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Função para renderizar estrelas de avaliação
        function renderizarEstrelas(avaliacao) {
            const estrelas = Math.round(avaliacao);
            let html = '';
            
            for (let i = 1; i <= 5; i++) {
                if (i <= estrelas) {
                    html += '<i class="fas fa-star text-warning"></i>';
                } else {
                    html += '<i class="far fa-star text-warning"></i>';
                }
            }
            
            return `<div class="rating">${html} <span class="rating-value">(${avaliacao.toFixed(1)})</span></div>`;
        }
        
        // Função para renderizar status de locação
        function renderizarStatusLocacao(status) {
            switch (status) {
                case 'Concluída':
                    return '<span class="badge badge-success">Concluída</span>';
                case 'Em andamento':
                    return '<span class="badge badge-primary">Em andamento</span>';
                case 'Agendada':
                    return '<span class="badge badge-info">Agendada</span>';
                case 'Cancelada':
                    return '<span class="badge badge-danger">Cancelada</span>';
                default:
                    return '<span class="badge badge-secondary">Desconhecido</span>';
            }
        }
        
        // Função para formatar data
        function formatarData(dataStr) {
            if (!dataStr) return '';
            
            const data = new Date(dataStr);
            return data.toLocaleDateString('pt-BR');
        }
        
        // Função para buscar carros
        function buscarCarros() {
            const termo = document.getElementById('search-carros').value.toLowerCase();
            
            if (!termo) {
                carregarCarrosDisponiveisOffline();
                return;
            }
            
            const carros = JSON.parse(localStorage.getItem('demoCarros') || '[]');
            const locadoras = JSON.parse(localStorage.getItem('demoUsuarios') || '[]').filter(u => u.tipo === 'locadora');
            
            // Filtrar carros disponíveis que correspondem ao termo de busca
            const carrosFiltrados = carros.filter(carro => 
                carro.disponivel && (
                    carro.marca.toLowerCase().includes(termo) ||
                    carro.modelo.toLowerCase().includes(termo) ||
                    carro.cor.toLowerCase().includes(termo)
                )
            );
            
            // Adicionar informações da locadora
            const carrosCompletos = carrosFiltrados.map(carro => {
                const locadora = locadoras.find(l => l.id == carro.locadoraId);
                
                return {
                    ...carro,
                    locadora: locadora ? locadora.razaoSocial : 'Desconhecida',
                    locadoraAvaliacao: locadora ? locadora.avaliacao : 0
                };
            });
            
            renderizarCarrosDisponiveis(carrosCompletos);
        }
        
        // Funções de ação (implementações simplificadas para demonstração)
        function visualizarCarro(id) {
            alert(`Visualizando carro ID: ${id}`);
        }
        
        function editarCarro(id) {
            window.location.href = `editar-carro.html?id=${id}`;
        }
        
        function excluirCarro(id) {
            if (confirm('Tem certeza que deseja excluir este carro?')) {
                alert(`Carro ID: ${id} excluído com sucesso!`);
                
                // Atualizar lista de carros
                const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');
                carregarCarrosOffline(usuario.id);
            }
        }
        
        function visualizarCliente(id) {
            alert(`Visualizando cliente ID: ${id}`);
        }
        
        function verLocacoesCliente(id) {
            alert(`Visualizando locações do cliente ID: ${id}`);
        }
        
        function visualizarLocacao(id) {
            alert(`Visualizando locação ID: ${id}`);
        }
        
        function avaliarLocatario(id) {
            window.location.href = `avaliar-locatario.html?id=${id}`;
        }
        
        function concluirLocacao(id) {
            if (confirm('Tem certeza que deseja concluir esta locação?')) {
                alert(`Locação ID: ${id} concluída com sucesso!`);
                
                // Atualizar lista de locações
                const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');
                carregarLocacoesOffline(usuario.id);
            }
        }
        
        function visualizarCarroDisponivel(id) {
            alert(`Visualizando carro disponível ID: ${id}`);
        }
        
        function solicitarLocacao(id) {
            window.location.href = `solicitar-locacao.html?carroId=${id}`;
        }
        
        function visualizarMinhaLocacao(id) {
            alert(`Visualizando minha locação ID: ${id}`);
        }
        
        function avaliarLocadora(id) {
            window.location.href = `avaliar-locadora.html?id=${id}`;
        }
        
        function visualizarLocadora(id) {
            alert(`Visualizando locadora ID: ${id}`);
        }
        
        function verCarrosLocadora(id) {
            window.location.href = `carros-locadora.html?id=${id}`;
        }
        
        // Função para logout
        function logout() {
            localStorage.removeItem('usuario');
            localStorage.removeItem('token');
            window.location.href = 'login.html?logout=success';
        }
    </script>
</body>
</html>
